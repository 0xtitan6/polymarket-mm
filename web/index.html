<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket MM Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a0a;
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #333;
        }

        h1 {
            font-size: 32px;
            font-weight: 700;
            color: #fff;
        }

        #connection-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-connecting {
            background: #444;
            color: #aaa;
        }

        .status-connected {
            background: #1a4d1a;
            color: #4caf50;
        }

        .status-disconnected {
            background: #4d1a1a;
            color: #f44336;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
        }

        .card h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #fff;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #222;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #999;
            font-size: 14px;
        }

        .metric-value {
            font-weight: 600;
            font-size: 16px;
            font-family: 'Courier New', monospace;
        }

        .positive {
            color: #4caf50;
        }

        .negative {
            color: #f44336;
        }

        .neutral {
            color: #e0e0e0;
        }

        .warning {
            color: #ff9800;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            text-align: left;
            padding: 12px 8px;
            background: #222;
            border-bottom: 2px solid #333;
            font-weight: 600;
            color: #fff;
            font-size: 12px;
            text-transform: uppercase;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid #222;
            font-family: 'Courier New', monospace;
        }

        tr:hover {
            background: #222;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        #activity-feed {
            max-height: 300px;
            overflow-y: auto;
            font-size: 13px;
        }

        .activity-item {
            padding: 10px;
            border-bottom: 1px solid #222;
            font-family: 'Courier New', monospace;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-time {
            color: #666;
            font-size: 11px;
        }

        .activity-fill {
            color: #2196f3;
        }

        .activity-kill {
            color: #f44336;
            font-weight: 700;
        }

        a {
            color: #2196f3;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-stale {
            background: #4d1a1a;
            color: #f44336;
        }

        .badge-fresh {
            background: #1a4d1a;
            color: #4caf50;
        }

        #pnl-chart {
            margin-top: 15px;
            max-height: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Polymarket Market Maker</h1>
            <div id="connection-status" class="status-connecting">Connecting...</div>
        </header>

        <div class="grid">
            <!-- Aggregate P&L -->
            <div class="card">
                <h2>Aggregate P&L</h2>
                <div class="metric">
                    <span class="metric-label">Realized</span>
                    <span class="metric-value" id="total-realized">$0.00</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Unrealized</span>
                    <span class="metric-value" id="total-unrealized">$0.00</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Total P&L</span>
                    <span class="metric-value" id="total-pnl">$0.00</span>
                </div>
                <canvas id="pnl-chart"></canvas>
            </div>

            <!-- Risk Status -->
            <div class="card">
                <h2>Risk Status</h2>
                <div class="metric">
                    <span class="metric-label">Global Exposure</span>
                    <span class="metric-value" id="global-exposure">$0 / $0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Exposure %</span>
                    <span class="metric-value" id="exposure-pct">0%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Active Markets</span>
                    <span class="metric-value" id="active-markets">0 / 0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Kill Switch</span>
                    <span class="metric-value" id="kill-switch">Inactive</span>
                </div>
            </div>

            <!-- Config Display -->
            <div class="card">
                <h2>Strategy Config</h2>
                <div id="config-display"></div>
            </div>
        </div>

        <!-- Active Markets Table -->
        <div class="card full-width">
            <h2>Active Markets</h2>
            <table id="markets-table">
                <thead>
                    <tr>
                        <th>Market</th>
                        <th>Mid</th>
                        <th>Spread</th>
                        <th>Position</th>
                        <th>PnL</th>
                        <th>Exposure</th>
                        <th>Skew</th>
                        <th>Bid</th>
                        <th>Ask</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="markets-tbody">
                    <tr>
                        <td colspan="10" style="text-align: center; color: #666;">No active markets</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Activity Feed -->
        <div class="card full-width">
            <h2>Activity Feed</h2>
            <div id="activity-feed">
                <div style="text-align: center; color: #666; padding: 20px;">Waiting for activity...</div>
            </div>
        </div>
    </div>

    <script>
        // State
        let state = {
            markets: [],
            risk: {},
            config: {},
            pnlHistory: {
                labels: [],
                data: []
            }
        };

        // WebSocket connection
        let ws = null;
        let reconnectDelay = 1000;
        const maxReconnectDelay = 30000;

        // P&L Chart
        const pnlChart = new Chart(document.getElementById('pnl-chart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Total P&L',
                    data: [],
                    borderColor: '#2196f3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        display: false
                    },
                    y: {
                        grid: {
                            color: '#333'
                        },
                        ticks: {
                            color: '#999',
                            callback: function(value) {
                                return '$' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });

        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket connected');
                updateConnectionStatus('connected');
                reconnectDelay = 1000;
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleMessage(msg);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('WebSocket closed');
                updateConnectionStatus('disconnected');
                setTimeout(() => {
                    reconnectDelay = Math.min(reconnectDelay * 1.5, maxReconnectDelay);
                    connect();
                }, reconnectDelay);
            };
        }

        function handleMessage(msg) {
            switch (msg.type) {
                case 'snapshot':
                    handleSnapshot(msg.data);
                    break;
                case 'fill':
                    handleFill(msg.data);
                    break;
                case 'position':
                    handlePosition(msg.data, msg.market_id);
                    break;
                case 'kill':
                    handleKill(msg.data);
                    break;
            }
        }

        function handleSnapshot(snapshot) {
            state.markets = snapshot.markets || [];
            state.risk = snapshot.risk || {};
            state.config = snapshot.config || {};

            renderPnL(snapshot.total_realized, snapshot.total_unrealized, snapshot.total_pnl);
            renderRisk(state.risk);
            renderMarkets(state.markets);
            renderConfig(state.config);

            // Add to P&L history
            addPnLPoint(snapshot.total_pnl);
        }

        function handleFill(fill) {
            addActivity(`FILL: ${fill.side} ${fill.size.toFixed(2)} @ ${fill.price.toFixed(4)} in ${fill.market_slug}`, 'activity-fill');

            // Update P&L display
            renderPnL(fill.realized_pnl, fill.unrealized_pnl, fill.realized_pnl + fill.unrealized_pnl);
            addPnLPoint(fill.realized_pnl + fill.unrealized_pnl);
        }

        function handlePosition(position, marketId) {
            // Update market in list
            const idx = state.markets.findIndex(m => m.condition_id === marketId);
            if (idx >= 0) {
                state.markets[idx].position = {
                    yes_qty: position.yes_qty,
                    no_qty: position.no_qty,
                    realized_pnl: position.realized_pnl,
                    unrealized_pnl: position.unrealized_pnl,
                    exposure_usd: position.exposure_usd,
                    skew: position.skew
                };
                renderMarkets(state.markets);
            }
        }

        function handleKill(kill) {
            addActivity(`⚠️ KILL SIGNAL: ${kill.reason} ${kill.details}`, 'activity-kill');
            state.risk.kill_switch_active = true;
            state.risk.kill_switch_until = kill.until;
            state.risk.kill_switch_reason = kill.reason;
            renderRisk(state.risk);
        }

        function renderPnL(realized, unrealized, total) {
            document.getElementById('total-realized').textContent = formatCurrency(realized);
            document.getElementById('total-realized').className = 'metric-value ' + pnlClass(realized);

            document.getElementById('total-unrealized').textContent = formatCurrency(unrealized);
            document.getElementById('total-unrealized').className = 'metric-value ' + pnlClass(unrealized);

            document.getElementById('total-pnl').textContent = formatCurrency(total);
            document.getElementById('total-pnl').className = 'metric-value ' + pnlClass(total);
        }

        function renderRisk(risk) {
            document.getElementById('global-exposure').textContent =
                `${formatCurrency(risk.global_exposure)} / ${formatCurrency(risk.max_global_exposure)}`;

            const pct = risk.exposure_pct || 0;
            const pctEl = document.getElementById('exposure-pct');
            pctEl.textContent = pct.toFixed(1) + '%';
            pctEl.className = 'metric-value ' + (pct > 80 ? 'warning' : pct > 95 ? 'negative' : 'neutral');

            document.getElementById('active-markets').textContent =
                `${risk.current_markets_active || 0} / ${risk.max_markets_active || 0}`;

            const killEl = document.getElementById('kill-switch');
            if (risk.kill_switch_active) {
                killEl.textContent = `ACTIVE (${risk.kill_switch_reason || 'unknown'})`;
                killEl.className = 'metric-value negative';
            } else {
                killEl.textContent = 'Inactive';
                killEl.className = 'metric-value positive';
            }
        }

        function renderMarkets(markets) {
            const tbody = document.getElementById('markets-tbody');
            if (!markets || markets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #666;">No active markets</td></tr>';
                return;
            }

            tbody.innerHTML = markets.map(m => {
                const pos = m.position || {};
                const pnl = (pos.realized_pnl || 0) + (pos.unrealized_pnl || 0);
                const posStr = `${pos.yes_qty ? pos.yes_qty.toFixed(1) : '0'}Y / ${pos.no_qty ? pos.no_qty.toFixed(1) : '0'}N`;

                const stale = m.is_stale ? '<span class="badge badge-stale">STALE</span>' : '<span class="badge badge-fresh">LIVE</span>';

                return `<tr>
                    <td><a href="https://polymarket.com/event/${m.slug}" target="_blank">${m.slug.substring(0, 40)}</a></td>
                    <td>${m.mid_price.toFixed(4)}</td>
                    <td>${m.spread_bps.toFixed(0)} bps</td>
                    <td>${posStr}</td>
                    <td class="${pnlClass(pnl)}">${formatCurrency(pnl)}</td>
                    <td>${formatCurrency(pos.exposure_usd || 0)}</td>
                    <td class="${pnlClass(pos.skew || 0)}">${((pos.skew || 0) * 100).toFixed(1)}%</td>
                    <td>${m.best_bid.toFixed(4)}</td>
                    <td>${m.best_ask.toFixed(4)}</td>
                    <td>${stale}</td>
                </tr>`;
            }).join('');
        }

        function renderConfig(cfg) {
            const display = document.getElementById('config-display');
            if (!cfg || Object.keys(cfg).length === 0) {
                display.innerHTML = '<div style="color: #666;">No config loaded</div>';
                return;
            }

            display.innerHTML = `
                <div class="metric"><span class="metric-label">Gamma</span><span class="metric-value">${cfg.gamma || 0}</span></div>
                <div class="metric"><span class="metric-label">Sigma</span><span class="metric-value">${cfg.sigma || 0}</span></div>
                <div class="metric"><span class="metric-label">Order Size</span><span class="metric-value">${formatCurrency(cfg.order_size_usd || 0)}</span></div>
                <div class="metric"><span class="metric-label">Min Spread</span><span class="metric-value">${cfg.default_spread_bps || 0} bps</span></div>
                <div class="metric"><span class="metric-label">Refresh</span><span class="metric-value">${cfg.refresh_interval || 'N/A'}</span></div>
                <div class="metric"><span class="metric-label">Dry Run</span><span class="metric-value ${cfg.dry_run ? 'warning' : 'positive'}">${cfg.dry_run ? 'YES' : 'NO'}</span></div>
            `;
        }

        function addActivity(text, cssClass = '') {
            const feed = document.getElementById('activity-feed');
            const time = new Date().toLocaleTimeString();

            const item = document.createElement('div');
            item.className = `activity-item ${cssClass}`;
            item.innerHTML = `<span class="activity-time">${time}</span> ${text}`;

            if (feed.firstChild && feed.firstChild.textContent.includes('Waiting for activity')) {
                feed.innerHTML = '';
            }

            feed.insertBefore(item, feed.firstChild);

            // Keep only last 50 items
            while (feed.children.length > 50) {
                feed.removeChild(feed.lastChild);
            }
        }

        function addPnLPoint(value) {
            const time = new Date().toLocaleTimeString();
            state.pnlHistory.labels.push(time);
            state.pnlHistory.data.push(value);

            if (state.pnlHistory.labels.length > 100) {
                state.pnlHistory.labels.shift();
                state.pnlHistory.data.shift();
            }

            pnlChart.data.labels = state.pnlHistory.labels;
            pnlChart.data.datasets[0].data = state.pnlHistory.data;

            // Update line color based on current P&L
            if (value >= 0) {
                pnlChart.data.datasets[0].borderColor = '#4caf50';
                pnlChart.data.datasets[0].backgroundColor = 'rgba(76, 175, 80, 0.1)';
            } else {
                pnlChart.data.datasets[0].borderColor = '#f44336';
                pnlChart.data.datasets[0].backgroundColor = 'rgba(244, 67, 54, 0.1)';
            }

            pnlChart.update('none');
        }

        function updateConnectionStatus(status) {
            const el = document.getElementById('connection-status');
            if (status === 'connected') {
                el.textContent = 'Connected';
                el.className = 'status-connected';
            } else if (status === 'disconnected') {
                el.textContent = 'Disconnected';
                el.className = 'status-disconnected';
            } else {
                el.textContent = 'Connecting...';
                el.className = 'status-connecting';
            }
        }

        function formatCurrency(value) {
            if (value === undefined || value === null) return '$0.00';
            return '$' + value.toFixed(2);
        }

        function pnlClass(value) {
            if (value > 0) return 'positive';
            if (value < 0) return 'negative';
            return 'neutral';
        }

        // Initialize
        connect();
    </script>
</body>
</html>
